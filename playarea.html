<html>
    <head>
        <title>Playarea</title>
        <style>
            body {
                background: black;
            }
            #playarea {
                width: 512px;
                height: 392px;
                border: 1px solid white;
                margin: auto;
                margin-top: 30px;
            }
            #objectContainer {
                position: relative;
                width: 100%;
                height: 100%;
            }
            .hitCircleCanvas {
                position: absolute;
                border: 1px solid rgba(39, 0, 255, 0.25);
            }
            .sliderCanvas {
                position: absolute;
                border: 1px solid rgba(255, 0, 255, 0.25);
            }
        </style>
    </head>
    <body>
        <div id="playarea">
            <div id="objectContainer"></div>
        </div>
        
        <script src="osuweb.js"></script>
        <script>
            var width = Math.floor(window.innerWidth * 0.5 / 4) * 4;
            width = 800;
            var height = width * 3 / 4;
            var playareaDom = document.getElementById("playarea");
            playareaDom.style.width = width, playareaDom.style.height = height;
            var objectContainerDom = document.getElementById("objectContainer");
            
            var pixelRatio = width / 640;
            var cs = 4;
            var csPixel = Math.round((109 - 9 * cs) / 640 * width);
            var halfCsPixel = csPixel / 2;
            var PI2 = Math.PI * 2;
            var sliderTracePointDistance = 4;
            
            function appendHitCircle(data) {
                var x = data.x,
                    y = data.y,
                    color = "#3c3cdd";
                
                var canvas = document.createElement("canvas"); // Create local object canvas
                canvas.setAttribute("width", csPixel);
                canvas.setAttribute("height", csPixel);
                canvas.className = "hitCircleCanvas";
                canvas.style.left = (x * pixelRatio - halfCsPixel) + "px", canvas.style.top = (y * pixelRatio - halfCsPixel) + "px";
                
                var ctx = canvas.getContext("2d");
                drawCircle(ctx, 0, 0);
                
                objectContainerDom.appendChild(canvas);
            }
            
            function benchmark(callback) {
    console.log('Benchmarking "' + callback.toString() + '"...');
    
    var startDate = Date.now();
    var times = 0;
    
    while (Date.now() - startDate < 3000) {
        callback();
        times++;
    }
    
    var ellapsedTime = Date.now() - startDate;
    console.log("Function exeucted " + Number((times / (ellapsedTime / 1000)).toFixed(5)) + " times a second.");
    console.log("Average execution time: " + (ellapsedTime / times).toFixed(7) + " ms.");
}
            
            var derp = new Slider({sections: [
                {
                    sectionType: "bezier",
                    points: [
                        {x: 100, y: 100},
                        {x: 300, y: 300},
                        {x: 100, y: 390},
                        {x: 400, y: 200}
                    ]
                },
                {
                    sectionType: "bezier",
                    points: [
                        {x: 400, y: 200},
                        {x: 700, y: 310},
                        {x: 400, y: 420},
                    ]
                },
                {
                    sectionType: "linear",
                    points: [
                        {x: 400, y: 420},
                        {x: 210, y: 100}
                    ]
                }
            ]});
            derp.append();
            
            function Slider(data) {
                this.type = "slider";
                this.time = data.time;
                this.newCombo = data.newCombo;
                this.x = data.x, this.y = data.y;
                this.sections = data.sections;
                this.repeat = data.repeat;
                this.length = data.length;
                
                this.sliderPathPoints = [];
                
                function pushPos(pos) {
                    this.sliderPathPoints.push(pos);
                    
                    this.minX = Math.min(this.minX, pos.x);
                    this.minY = Math.min(this.minY, pos.y);
                    this.maxX = Math.max(this.maxX, pos.x);
                    this.maxY = Math.max(this.maxY, pos.y);
                }
                
                var initialPointTracing = [],
                    minX, minY, maxX, maxY;
                
                if (this.sections[0].sectionType == "circle") {
                    var points = this.sections[0].points;
                    
                    var centerPos = osuweb.mathutil.circleCenterPos(points[0], points[1], points[2]);
                    var radius = Math.hypot(centerPos.x - points[0].x, centerPos.y - points[0].y);
                    var a1 = Math.atan2(points[0].y - centerPos.y, points[0].x - centerPos.x), // angle to start
                        a2 = Math.atan2(points[1].y - centerPos.y, points[1].x - centerPos.x), // angle to control point
                        a3 = Math.atan2(points[2].y - centerPos.y, points[2].x - centerPos.x); // angle to end
                    
                    var incre = sliderTracePointDistance / radius, condition;
                    
                    if (a1 < a2 && a2 < a3) { // Point order
                        condition = function(x) {return x < a3};
                    } else if ((a2 < a3 && a3 < a1) || (a3 < a1 && a1 < a2)) {
                        condition = function(x) {return x < a3 + PI2};
                    } else if (a3 < a1 && a1 < a2) {
                        condition = function(x) {return x < a3 + PI2};
                    } else if (a3 < a2 && a2 < a1) {
                        condition = function(x) {return x > a3};
                        incre *= -1;
                    } else {
                        condition = function(x) {return x > a3 - PI2};
                        incre *= -1;
                    }
                    
                    this.minX = this.maxX = (centerPos.x + radius * Math.cos(a1)) * pixelRatio;
                    this.minY = this.maxY = (centerPos.y + radius * Math.sin(a1)) * pixelRatio;
                    
                    for (var angle = a1; condition(angle); angle += incre) {
                        pushPos.bind(this)({
                            x: (centerPos.x + radius * Math.cos(angle)) * pixelRatio,
                            y: (centerPos.y + radius * Math.sin(angle)) * pixelRatio
                        });
                    }
                } else {
                    for (var i = 0; i < this.sections.length; i++) {
                        for (var t = 0; t < 1; t = Math.round((t + 0.0001) * 10000) / 10000) {
                            var pos = osuweb.mathutil.coordsOnBezier(this.sections[i].points, t);
                            initialPointTracing.push({
                                x: pos.x * pixelRatio,
                                y: pos.y * pixelRatio
                            });
                        }
                    }

                    this.minX = this.maxX = initialPointTracing[0].x;
                    this.minY = this.maxY = initialPointTracing[0].y;
                    
                    var passedDist = 0;
                    this.sliderPathPoints[0] = initialPointTracing[0]; // Pushes startpoint to array
                    for (var i = 0; i < initialPointTracing.length - 1; i++) {
                        var dist = Math.hypot(initialPointTracing[i + 1].x - initialPointTracing[i].x, initialPointTracing[i + 1].y - initialPointTracing[i].y);
                        passedDist += dist;
                        
                        if (passedDist >= sliderTracePointDistance) {
                            pushPos.bind(this)(initialPointTracing[i]);
                            passedDist = dist - passedDist;
                        }
                    }
                }
                
                var endPos = this.sections[this.sections.length - 1].points[this.sections[this.sections.length - 1].points.length - 1];
                pushPos.bind(this)({
                    x: endPos.x * pixelRatio,
                    y: endPos.y * pixelRatio
                }); // Pushes endpoint to array
                
                //console.log(this.sliderPathPoints.length);
                
                //////////
                
                this.append = function() {
                    var sliderWidth = this.maxX - this.minX, sliderHeight = this.maxY - this.minY;
                    
                    var canvas = document.createElement("canvas"); // Create local object canvas
                    canvas.setAttribute("width", sliderWidth + csPixel);
                    canvas.setAttribute("height", sliderHeight + csPixel);
                    canvas.className = "sliderCanvas";
                    canvas.style.left = (this.minX - halfCsPixel) + "px", canvas.style.top = (this.minY - halfCsPixel) + "px";
                    //canvas.style.display = "none";

                    var ctx = canvas.getContext("2d");

                    ctx.beginPath();
                    ctx.moveTo(this.sliderPathPoints[0].x - this.minX + halfCsPixel, this.sliderPathPoints[0].y - this.minY + halfCsPixel);
                    for (var i = 1; i < this.sliderPathPoints.length; i++) {
                        ctx.lineTo(this.sliderPathPoints[i].x - this.minX + halfCsPixel, this.sliderPathPoints[i].y - this.minY + halfCsPixel);
                    }
                    ctx.lineWidth = csPixel;
                    ctx.lineCap = "round";
                    ctx.lineJoin="round";
                    ctx.strokeStyle = "white";
                    ctx.stroke();

                    var sliderBodyRadius = halfCsPixel * 14.5 / 16;
                    ctx.lineCap = "round";
                    for (var i = sliderBodyRadius; i > 1; i -= 2) {
                        ctx.lineWidth = i * 2;
                        var completionRgb = Math.floor((1 - (i / sliderBodyRadius)) * 75);
                        ctx.strokeStyle = "rgb(" + completionRgb + ", " + completionRgb + ", "  + completionRgb + ")";
                        ctx.stroke();
                    }

                    drawCircle(ctx, this.sliderPathPoints[0].x - this.minX, this.sliderPathPoints[0].y - this.minY);

                    objectContainerDom.appendChild(canvas);
                }
            }
            
            function drawCircle(context, x, y) { // Draws circle used for Hit Circles, Slider Heads and Repeat Tails
                context.beginPath(); // Draw circle base (will become border)
                context.arc(x + halfCsPixel, y + halfCsPixel, halfCsPixel, 0, PI2);
                context.fillStyle = "white";
                context.fill();
                
                var radialGradient = context.createRadialGradient(x + halfCsPixel, y + halfCsPixel, 0, x + halfCsPixel, y + halfCsPixel, halfCsPixel);
                radialGradient.addColorStop(0, "#5c5c5c");
                radialGradient.addColorStop(1, "black");
                
                context.beginPath(); // Draw circle body with radial gradient
                context.arc(x + halfCsPixel, y + halfCsPixel, halfCsPixel * 14.5 / 16, 0, PI2);
                context.fillStyle = radialGradient;
                context.fill();
                
                var innerType = "dot";
                
                if (innerType == "number") {
                    context.font = "lighter 35px Arial";
                    context.textAlign = "center", context.textBaseline = "middle";
                    context.fillStyle = "white";
                    context.fillText("3", x + halfCsPixel, y + halfCsPixel);
                } else {
                    context.beginPath();
                    context.arc(x + halfCsPixel, y + halfCsPixel, halfCsPixel * 0.25, 0, PI2);
                    context.fillStyle = "white";
                    context.fill();
                }
            }
        </script>
    </body>
</html>