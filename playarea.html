<html>
    <head>
        <title>Playarea</title>
        <style>
            body {
                background: black;
            }
            #playarea {
                width: 512px;
                height: 392px;
                border: 1px solid gray;
                margin: auto;
                margin-top: 30px;
            }
            #objectContainer {
                position: relative;
                width: 100%;
                height: 100%;
            }
            .hitCircleCanvas {
                position: absolute;
                background: blue;
            }
            .sliderCanvas {
                position: absolute;
                background: magenta;
            }
        </style>
    </head>
    <body>
        <div id="playarea">
            <div id="objectContainer"></div>
        </div>
        
        <script src="osuweb.js"></script>
        <script>
            var width = Math.floor(window.innerWidth * 0.5 / 4) * 4;
            var height = width * 3 / 4;
            var playareaDom = document.getElementById("playarea");
            playareaDom.style.width = width, playareaDom.style.height = height;
            var objectContainerDom = document.getElementById("objectContainer");
            
            var pixelRatio = width / 640;
            var cs = 4;
            var csPixel = Math.round((109 - 9 * cs) / 640 * width);
            var halfCsPixel = csPixel / 2;
            var PI2 = Math.PI * 2;
            var sliderTracePointDistance = 2;
            
            function appendHitCircle(data) {
                var x = data.x,
                    y = data.y,
                    color = "#3c3cdd";
                
                var canvas = document.createElement("canvas"); // Create local object canvas
                canvas.setAttribute("width", csPixel);
                canvas.setAttribute("height", csPixel);
                canvas.className = "hitCircleCanvas";
                canvas.style.left = (x * pixelRatio - halfCsPixel) + "px", canvas.style.top = (y * pixelRatio - halfCsPixel) + "px";
                
                var ctx = canvas.getContext("2d");
                drawCircle(ctx, 0, 0);
                
                objectContainerDom.appendChild(canvas);
            }
            
            appendSlider({
                sections: [
                    {points: [
                        {x: 100, y: 100},
                        {x: 300, y: 200},
                        {x: 150, y: 300}
                    ]},
                    {points: [
                        {x: 150, y: 300},
                        {x: 400, y: 400},
                    ]},
                    {points: [
                        {x: 400, y: 400},
                        {x: 400, y: 200},
                        {x: 500, y: 50}
                    ]}
                ]
            });
            
            function appendSlider(data) {
                var componentSections = data.sections;
                
                var initialPointTracing = [],
                    sliderShapePoints = [];
                
                for (var i = 0; i < componentSections.length; i++) {
                    var ctrlPoints = componentSections[i].points;
                    
                    for (var t = 0; t < 1; t = Math.round((t + 0.0001) * 10000) / 10000) {
                        var pos = osuweb.mathutil.coordsOnBezier(ctrlPoints, t);
                        initialPointTracing.push({
                            x: pos.x * pixelRatio,
                            y: pos.y * pixelRatio
                        });
                    }
                }
                
                var passedDist = 0;
                var minX, minY, maxX, maxY;
                minX = maxX = initialPointTracing[0].x;
                minY = maxY = initialPointTracing[0].y;
                
                sliderShapePoints[0] = initialPointTracing[0]; // Pushes startpoint to array
                for (var i = 0; i < initialPointTracing.length - 1; i++) {
                    var dist = Math.hypot(initialPointTracing[i + 1].x - initialPointTracing[i].x, initialPointTracing[i + 1].y - initialPointTracing[i].y);
                    
                    passedDist += dist;
                    if (passedDist >= sliderTracePointDistance) {
                        pushPos(initialPointTracing[i]);
                        passedDist = dist - passedDist;
                    }
                }
                var endPos = componentSections[componentSections.length - 1].points[componentSections[componentSections.length - 1].points.length - 1];
                pushPos({
                    x: endPos.x * pixelRatio,
                    y: endPos.y * pixelRatio
                }); // Pushes endpoint to array
                
                function pushPos(pos) {
                    sliderShapePoints.push(pos);
                    
                    minX = Math.min(minX, pos.x);
                    minY = Math.min(minY, pos.y);
                    maxX = Math.max(maxX, pos.x);
                    maxY = Math.max(maxY, pos.y);
                }
                
                var sliderWidth = maxX - minY, sliderHeight = maxY - minY;
                
                var canvas = document.createElement("canvas"); // Create local object canvas
                canvas.setAttribute("width", sliderWidth + csPixel);
                canvas.setAttribute("height", sliderHeight + csPixel);
                canvas.className = "sliderCanvas";
                canvas.style.left = (minX * pixelRatio - halfCsPixel) + "px", canvas.style.top = (minY * pixelRatio - halfCsPixel) + "px";
                
                var ctx = canvas.getContext("2d");
                
                ctx.beginPath();
                ctx.moveTo(sliderShapePoints[0].x - minX + halfCsPixel, sliderShapePoints[0].y - minY + halfCsPixel);
                for (var i = 1; i < sliderShapePoints.length; i++) {
                    ctx.lineTo(sliderShapePoints[i].x - minX + halfCsPixel, sliderShapePoints[i].y - minY + halfCsPixel);
                }
                ctx.lineWidth = csPixel;
                ctx.lineCap = "round";
                ctx.strokeStyle = "white";
                ctx.stroke();
                
                var sliderBodyRadius = halfCsPixel * 14.5 / 16;
                
                for (var i = 0; i <= sliderShapePoints.length; i += sliderShapePoints.length - 1) {
                    var pos = sliderShapePoints[i];
                    
                    pos = {
                        x: pos.x - minX + halfCsPixel,
                        y: pos.y - minY + halfCsPixel
                    };
                    
                    var gradient = ctx.createRadialGradient(pos.x, pos.y, 0, pos.x, pos.y, sliderBodyRadius);
                    gradient.addColorStop(0, "gray");
                    gradient.addColorStop(1, "black");

                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, sliderBodyRadius, 0, Math.PI * 2);
                    ctx.fillStyle = gradient;
                    ctx.fill();
                }
                
                ctx.lineWidth = 7;
                ctx.lineCap = "butt";
                for (var i = 0; i < sliderShapePoints.length; i++) {
                    var pos = sliderShapePoints[i];
                    var posBefore = sliderShapePoints[i - 1];
                    
                    if (i == 0) {
                        posBefore = pos;
                        pos = sliderShapePoints[i + 1];
                    }
                    
                    pos = {
                        x: pos.x - minX + halfCsPixel,
                        y: pos.y - minY + halfCsPixel
                    };
                    posBefore = {
                        x: posBefore.x - minX + halfCsPixel,
                        y: posBefore.y - minY + halfCsPixel
                    }

                    var angle = Math.atan2(-1 / (posBefore.y - pos.y), 1 / (posBefore.x - pos.x));
                    var offX1 = pos.x + Math.cos(angle) * sliderBodyRadius, offX2 = pos.x - Math.cos(angle) * sliderBodyRadius;
                    var offY1 = pos.y + Math.sin(angle) * sliderBodyRadius, offY2 = pos.y - Math.sin(angle) * sliderBodyRadius;

                    var gradient = ctx.createLinearGradient(offX1, offY1, offX2, offY2);
                    gradient.addColorStop(0, "black"); 
                    gradient.addColorStop(0.5, "gray"); 
                    gradient.addColorStop(1, "black"); 

                    ctx.beginPath();
                    ctx.moveTo(offX1, offY1);
                    ctx.lineTo(offX2, offY2);
                    ctx.strokeStyle = gradient;
                    ctx.stroke();
                }
                
                objectContainerDom.appendChild(canvas);
                
                console.log(minX, minY, maxX, maxY);
            }
            
            function drawCircle(context, x, y) { // Draws circle used for Hit Circles, Slider Heads and Repeat Tails
                context.beginPath(); // Draw circle base (will become border)
                context.arc(x + halfCsPixel, y + halfCsPixel, halfCsPixel, 0, PI2);
                context.fillStyle = "white";
                context.fill();
                
                var radialGradient = context.createRadialGradient(x + halfCsPixel, y + halfCsPixel, 0, x + halfCsPixel, y + halfCsPixel, halfCsPixel);
                radialGradient.addColorStop(0, "#5c5c5c");
                radialGradient.addColorStop(1, "black");
                
                context.beginPath(); // Draw circle body with radial gradient
                context.arc(x + halfCsPixel, y + halfCsPixel, halfCsPixel * 14.5 / 16, 0, PI2);
                context.fillStyle = radialGradient;
                context.fill();
                
                var innerType = "whatever";
                
                if (innerType == "number") {
                    context.font = "lighter 35px Arial";
                    context.textAlign = "center", context.textBaseline = "middle";
                    context.fillStyle = "white";
                    context.fillText("3", x + halfCsPixel, y + halfCsPixel);
                } else {
                    context.beginPath();
                    context.arc(x + halfCsPixel, y + halfCsPixel, halfCsPixel * 0.25, 0, PI2);
                    context.fillStyle = "white";
                    context.fill();
                }
            }
        </script>
    </body>
</html>